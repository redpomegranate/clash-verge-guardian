name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build
        shell: pwsh
        run: |
          powershell -ExecutionPolicy Bypass -File .\build.ps1

      - name: Prepare Release Notes + Hash
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $tag = "${{ github.ref_name }}"

          $exe = Join-Path $PWD "dist\ClashGuardian.exe"
          if (-not (Test-Path $exe)) { throw "Missing artifact: $exe" }

          $hash = (Get-FileHash $exe -Algorithm SHA256).Hash
          $shaFile = Join-Path $PWD "dist\ClashGuardian.exe.sha256"
          "$hash  ClashGuardian.exe" | Out-File -Encoding ascii -FilePath $shaFile

          # Keep release notes simple and robust: point to README changelog section.
          $out = @()
          $out += "# Clash Guardian Pro $tag"
          $out += ""
          $out += "更新日志：请查看 README.md 中的 `### $tag` 段落。"
          $out += ""
          $out += "## 校验"
          $out += ""
          $out += "```text"
          $out += "$hash  ClashGuardian.exe"
          $out += "```"

          $bodyPath = Join-Path $PWD "release_body.md"
          $out | Out-File -Encoding utf8 -FilePath $bodyPath

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Clash Guardian Pro ${{ github.ref_name }}
          body_path: release_body.md
          files: |
            dist/ClashGuardian.exe
            dist/ClashGuardian.exe.sha256
          fail_on_unmatched_files: true
